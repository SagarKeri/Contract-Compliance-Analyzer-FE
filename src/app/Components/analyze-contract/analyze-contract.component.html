<app-clause-details [clauseId]="selectedClauseId"></app-clause-details>
<div class="container-fluid mt-2 px-2 mb-4">
  <!-- Before File Upload: Centered Card -->
  <div *ngIf="!fileUploaded" class="d-flex justify-content-center">
    <div class="card card-border shadow-lg p-4 w-100" style="max-width: 600px">
      <div class="row g-3 align-items-center">
        <!-- File Upload -->
        <div class="col-12">
          <label for="contractUpload" class="btn btn-outline-primary w-100"
            >Upload Contract</label
          >
          <input
            type="file"
            id="contractUpload"
            (change)="onFileSelected($event)"
            accept="application/pdf"
            hidden
          />
          <div *ngIf="fileName" class="mt-2 text-secondary fw-bold small">
            Selected File: {{ fileName }}
          </div>
        </div>

        <!-- Model Selection -->
        <div class="col-12">
          <label for="modelSelect" class="form-label fw-bold text-secondary"
            >Select Model</label
          >
          <select
            id="modelSelect"
            class="form-select"
            [(ngModel)]="selectedModel"
            (change)="onModelChange($event)"
          >

            <option [value]="3">Llama 3.1</option>
            <!-- <option [value]="2">Gemini-2.5-pro</option> -->
          </select>
        </div>

        <!-- Country Selection -->
        <div class="col-12">
          <label for="countrySelect" class="form-label fw-bold text-secondary"
            >Select Country</label
          >
          <select
            id="countrySelect"
            class="form-select"
            [(ngModel)]="selectedCountry"
            (change)="onCountryChange($event)"
          >
            <option [value]="null">-- Select Country --</option>
            <option *ngFor="let country of countries" [value]="country._id">
              {{ country.country_name }}
            </option>
          </select>
        </div>

        <!-- Domain Selection -->
        <div class="col-12" *ngIf="domains.length > 0">
          <label for="domainSelect" class="form-label fw-bold text-secondary"
            >Select Domain</label
          >
          <select
            id="domainSelect"
            class="form-select"
            [(ngModel)]="selectedDomain"
            (change)="onDomainChange($event)"
          >
            <option [value]="null">-- Select Domain --</option>
            <option *ngFor="let domain of domains" [value]="domain._id">
              {{ domain.domain_name }}
            </option>
          </select>
        </div>

        <!-- Clauses Checklist -->
        <div class="col-12 mt-3" *ngIf="clauses.length > 0">
          <!-- Label + Select All in one row -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label fw-bold text-secondary mb-0">
              Select Clauses
            </label>

            <div class="form-check mb-0">
              <input
                type="checkbox"
                class="form-check-input"
                id="selectAllClauses"
                [(ngModel)]="selectAll"
                (change)="toggleSelectAll($event)"
                style="cursor: pointer"
              />
              <label
                class="form-check-label fw-semibold text-dark"
                for="selectAllClauses"
              >
                Select All
              </label>
            </div>
          </div>

          <!-- Fixed width + scrollable if too many -->
          <div
            class="border rounded shadow-sm bg-white p-2"
            style="max-height: 300px; overflow-y: auto"
          >
            <div
              class="d-flex align-items-center justify-content-between border rounded p-2 mb-2 shadow-sm bg-light"
              *ngFor="let clause of clauses"
              style="min-width: 360px"
            >
              <!-- Left: Checkbox + Clause Name -->
              <div class="d-flex align-items-center">
                <input
                  class="form-check-input me-2"
                  type="checkbox"
                  [id]="'clause' + clause._id"
                  [(ngModel)]="clause.selected"
                  (change)="onSingleClauseChange()"
                  style="cursor: pointer"
                />
                <label
                  class="form-check-label fw-semibold text-dark mb-0"
                  [for]="'clause' + clause._id"
                >
                  {{ clause.clause_name }}
                </label>
              </div>

              <!-- Right: View button -->
              <button
                class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#clauseModal"
                (click)="openClause(clause._id)"
              >
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Analyze Button -->
        <div class="col-12">
          <button
            class="btn btn-primary w-100"
            [disabled]="!isFormValid()"
            (click)="analyzeContract()"
          >
            Analyze
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="fileUploaded" class="row gx-3">
    <div class="col-md-3">
      <div class="card card-border shadow-lg p-4 mb-3">
        <div class="row g-3 align-items-center">
          <!-- Reuse same card content as above -->
          <ng-container *ngTemplateOutlet="selectionCard"></ng-container>
        </div>
      </div>
    </div>

    <!-- Column 2: Analysis Results -->
    <div class="col-md-5">
      <div class="accordion" id="analysisAccordion">
        <div class="accordion-item shadow-lg card-border">
          <h2 class="accordion-header" id="headingAnalysis">
            <button
              class="accordion-button text-secondary fw-bold"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseAnalysis"
              aria-expanded="true"
              aria-controls="collapseAnalysis"
            >
              Compliance Analysis Results
            </button>
          </h2>
          <div
            id="collapseAnalysis"
            class="accordion-collapse collapse show"
            aria-labelledby="headingAnalysis"
            data-bs-parent="#analysisAccordion"
          >
            <div
              class="accordion-body p-2"
              style="height: 80vh; display: flex; flex-direction: column"
            >
              <!-- Inner Accordion for Table & Cards -->
              <div class="accordion" id="innerAccordion">
                <!-- Table Section -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTable">
                    <button
                      class="accordion-button fw-bold text-primary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseTable"
                      aria-expanded="true"
                      aria-controls="collapseTable"
                    >
                      Clause Summary Table
                    </button>
                  </h2>
                  <div
                    id="collapseTable"
                    class="accordion-collapse collapse show"
                    aria-labelledby="headingTable"
                    data-bs-parent="#innerAccordion"
                  >
                    <div
                      class="accordion-body overflow-auto"
                      style="max-height: 500px"
                    >
                      <table
                        class="table table-bordered table-hover text-center align-middle shadow-sm"
                      >
                        <thead class="table-light">
                          <tr>
                            <th scope="col">Document Name</th>
                            <th scope="col">Sufficient %</th>
                            <th scope="col">Insufficient %</th>
                            <th scope="col">Missing %</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <!-- Dynamic document name -->
                            <td>
                              <strong>{{ selectedFile?.name }}</strong>
                            </td>

                            <!-- Percentages -->
                            <td class="text-success fw-bold">
                              {{ getPercentage("Sufficient") }}%
                            </td>
                            <td class="text-warning fw-bold">
                              {{ getPercentage("Insufficient") }}%
                            </td>
                            <td class="text-danger fw-bold">
                              {{ getPercentage("Missing") }}%
                            </td>
                          </tr>
                        </tbody>
                      </table>

                      <div class="mt-3 p-3 border rounded bg-light">
                        <h6 class="fw-bold text-secondary">Summary</h6>
                        <p class="mb-0 fst-italic">
                          {{
                            description ||
                              "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua."
                          }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Cards Section -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingCards">
                    <button
                      class="accordion-button collapsed fw-bold text-primary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseCards"
                      aria-expanded="false"
                      aria-controls="collapseCards"
                    >
                      Detailed Clause Analysis
                    </button>
                  </h2>
                  <div
                    id="collapseCards"
                    class="accordion-collapse collapse"
                    aria-labelledby="headingCards"
                    data-bs-parent="#innerAccordion"
                  >
                    <div
                      class="accordion-body overflow-auto"
                      style="max-height: 500px"
                    >
                      <!-- Bootstrap Tabs -->
                      <ul
                        class="nav nav-tabs text-primary mb-3"
                        id="analysisTabs"
                        role="tablist"
                      >
                        <li class="nav-item" role="presentation">
                          <button
                            class="nav-link active"
                            id="results-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#results"
                            type="button"
                            role="tab"
                            aria-controls="results"
                            aria-selected="true"
                          >
                            Results
                          </button>
                        </li>
                        <!-- <li class="nav-item" role="presentation">
                          <button
                            class="nav-link"
                            id="contract-genie-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#contract-genie"
                            type="button"
                            role="tab"
                            aria-controls="contract-genie"
                            aria-selected="false"
                          >
                            Contract Genie
                          </button>
                        </li> -->
                      </ul>

                      <div class="tab-content">
                        <!-- Results Tab -->
                        <div
                          class="tab-pane fade show active"
                          id="results"
                          role="tabpanel"
                          aria-labelledby="results-tab"
                        >
                          <!-- Filter Dropdown -->
                          <div class="mb-3 d-flex align-items-center gap-2">
                            <label
                              for="statusFilter"
                              class="form-label fw-bold text-secondary mb-0"
                            >
                              Filter by Status:
                            </label>
                            <select
                              id="statusFilter"
                              class="form-select w-auto"
                              [(ngModel)]="selectedStatus"
                            >
                              <option value="">All</option>
                              <option value="Sufficient">Sufficient</option>
                              <option value="Insufficient">Insufficient</option>
                              <option value="Missing">Missing</option>
                            </select>
                          </div>

                          <!-- Cards -->
                          <div
                            *ngIf="filteredAnalysisResult().length === 0"
                            class="text-muted"
                          >
                            No Results Found!
                          </div>

                          <div
                            *ngFor="let item of filteredAnalysisResult()"
                            class="card mb-3 shadow-sm"
                          >
                            <div class="card-body">
                              <h6 class="card-title text-primary">
                                {{ item.compliance_area }}
                              </h6>
                              <p class="mb-1">
                                <strong>Status:</strong>
                                {{ item.missing_clause }}
                              </p>
                              <p *ngIf="item.reason" class="mb-1">
                                <strong>Reason:</strong>
                                {{ item.reason }}
                              </p>

                              <p *ngIf="item.extracted_text">
                                <strong>Extracted Clause:</strong><br />
                                <span class="text-muted">{{
                                  item.extracted_text.split('...')[0]
                                }}</span>
                                <button
                                  class="btn btn-sm btn-link text-primary ms-2"
                                  (click)="highlightTextt(item.extracted_text.split('...')[0])"
                                >
                                  Jump in Pdf
                                  <i class="bi bi-arrow-up-right-square"></i>
                                </button>
                              </p>

                              <p
                                *ngIf="!item.extracted_text"
                                class="text-danger small"
                              >
                                Clause not found in the contract.
                              </p>
                            </div>
                          </div>
                        </div>

                        <!-- Contract Genie Tab -->
                        <div
                          class="tab-pane fade"
                          id="contract-genie"
                          role="tabpanel"
                          aria-labelledby="contract-genie-tab"
                        >
                          <app-contract-genie
                            [selectedFile]="selectedFile"
                          ></app-contract-genie>
                        </div>
                      </div>
                      <!-- End Tabs -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- Fixed Feedback Section -->
              <div
                *ngIf="analysisResult.length > 0"
                class="text-center rounded py-3 border-top bg-white"
                style="position: sticky; bottom: 0; z-index: 10"
              >
                <p class="fw-bold text-secondary mb-2">
                  Was this analysis helpful?
                </p>
                <button
                  class="btn btn-outline-success btn-sm me-2"
                  (click)="submitFeedback('like')"
                  [disabled]="feedbackSubmitted"
                >
                  <i class="bi bi-hand-thumbs-up"></i> Like
                </button>
                <button
                  class="btn btn-outline-danger btn-sm"
                  (click)="submitFeedback('dislike')"
                  [disabled]="feedbackSubmitted"
                >
                  <i class="bi bi-hand-thumbs-down"></i> Dislike
                </button>
                <div *ngIf="feedbackSubmitted" class="text-success mt-2 small">
                  Thank you for your feedback!
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Column 3: PDF Viewer -->
    <div class="col-md-4">
      <div class="accordion" id="pdfAccordion">
        <div class="accordion-item card-border shadow-lg">
          <h2 class="accordion-header" id="headingPdf">
            <button
              class="accordion-button text-secondary fw-bold"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapsePdf"
              aria-expanded="true"
              aria-controls="collapsePdf"
            >
              Contract PDF Viewer
            </button>
          </h2>
          <div
            id="collapsePdf"
            class="accordion-collapse collapse show"
            aria-labelledby="headingPdf"
            data-bs-parent="#pdfAccordion"
          >
            <div class="accordion-body overflow-hidden" style="height: 80vh">
              <ngx-extended-pdf-viewer
                [src]="pdfSrc"
                [textLayer]="true"
                [showHandToolButton]="true"
                [showDownloadButton]="false"
                [showPrintButton]="false"
                [showFindButton]="true"
                height="100%"
                (pdfLoaded)="loadComplete($event)"
                (pageRendered)="pageRendered($event)"
                (updateFindMatchesCount)="updateFindMatchesCount($event)"
                (updateFindState)="updateFindState($event)"
              ></ngx-extended-pdf-viewer>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <p *ngIf="errorMessage" class="text-danger mt-3">{{ errorMessage }}</p>

  <!-- Selection Card Template -->
  <ng-template #selectionCard>
    <!-- Place the same selection/upload card content here -->
    <div class="col-12">
      <label for="contractUpload" class="btn btn-outline-primary w-100"
        >Upload Contract</label
      >
      <input
        type="file"
        id="contractUpload"
        (change)="onFileSelected($event)"
        accept="application/pdf"
        hidden
      />
      <div *ngIf="fileName" class="mt-2 text-secondary fw-bold small">
        Selected File: {{ fileName }}
      </div>
    </div>
    <!-- Model Selection -->
    <div class="col-12">
      <label for="modelSelect" class="form-label fw-bold text-secondary"
        >Select Model</label
      >
      <select
        id="modelSelect"
        class="form-select"
        [(ngModel)]="selectedModel"
        (change)="onModelChange($event)"
      >
        <!-- <option [value]="1">Mistral</option>
        <option [value]="2">Gemini-2.5-pro</option> -->
        <option [value]="3">Llama 3.1</option>
      </select>
    </div>

    <!-- Country Selection -->
    <div class="col-12">
      <label for="countrySelect" class="form-label fw-bold text-secondary"
        >Select Country</label
      >
      <select
        id="countrySelect"
        class="form-select"
        [(ngModel)]="selectedCountry"
        (change)="onCountryChange($event)"
      >
        <option [value]="null">-- Select Country --</option>
        <option *ngFor="let country of countries" [value]="country._id">
          {{ country.country_name }}
        </option>
      </select>
    </div>

    <!-- Domain Selection -->
    <div class="col-12" *ngIf="domains.length > 0">
      <label for="domainSelect" class="form-label fw-bold text-secondary"
        >Select Domain</label
      >
      <select
        id="domainSelect"
        class="form-select"
        [(ngModel)]="selectedDomain"
        (change)="onDomainChange($event)"
      >
        <option [value]="null">-- Select Domain --</option>
        <option *ngFor="let domain of domains" [value]="domain._id">
          {{ domain.domain_name }}
        </option>
      </select>
    </div>

    <!-- Clauses Checklist -->
    <div class="col-12 mt-3" *ngIf="clauses.length > 0">
      <!-- Label + Select All in one row -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label fw-bold text-secondary mb-0">
          Select Clauses
        </label>

        <div class="form-check mb-0">
          <input
            type="checkbox"
            class="form-check-input"
            id="selectAllClauses"
            [(ngModel)]="selectAll"
            (change)="toggleSelectAll($event)"
            style="cursor: pointer"
          />
          <label
            class="form-check-label fw-semibold text-dark"
            for="selectAllClauses"
          >
            Select All
          </label>
        </div>
      </div>

      <!-- Scrollable box -->
      <div
        class="border rounded shadow-sm bg-white p-2"
        style="max-height: 300px; overflow-y: auto"
      >
        <div
          class="d-flex align-items-center justify-content-between border rounded p-2 mb-2 shadow-sm bg-light"
          *ngFor="let clause of clauses"
        >
          <!-- Left: Checkbox + Clause Name -->
          <div class="d-flex align-items-center">
            <input
              class="form-check-input me-2"
              type="checkbox"
              [id]="'clause' + clause._id"
              [(ngModel)]="clause.selected"
              (change)="onClauseChange(clause._id, $event)"
              style="cursor: pointer"
            />
            <label
              class="form-check-label fw-semibold text-dark mb-0"
              [for]="'clause' + clause._id"
            >
              {{ clause.clause_name }}
            </label>
          </div>

          <!-- Right: View button -->
          <button
            class="btn btn-sm btn-outline-primary"
            data-bs-toggle="modal"
            data-bs-target="#clauseModal"
            (click)="openClause(clause._id)"
          >
            <i class="bi bi-eye"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Analyze Button -->
    <div class="col-12">
      <button
        class="btn btn-primary w-100"
        [disabled]="!isFormValid()"
        (click)="analyzeContract()"
      >
        Analyze
      </button>
    </div>
  </ng-template>
</div>
